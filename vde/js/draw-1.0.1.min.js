/*
 * Viprin's Drawing Editor!
 * by Viprin
 * 17/12/12
 * Version 1.0.1
 */

var distance=function(xy1,xy2){return Math.sqrt(Math.pow(xy1[0]-xy2[0],2)+Math.pow(xy1[1]-xy2[1],2));};var Layers=function()
{this.target=0;this.layers=[];this.addLayer();};Layers.prototype={addLayer:function()
{this.layers.push(new this.Layer("Layer"+(this.layers.length+1)));this.target=this.layers.length-1;return this.target;},delLayer:function(target)
{if(this.layers.length>1&&target<this.layers.length){this.layers.splice(target,1);if(this.target==this.layers.length)this.target--;return this.target;}else{alert("Failed to delete: You need to have 1 layer at least!");return this.target;}},setTarget:function(target)
{if(this.layers.length>target)this.target=target;},orderUp:function(target)
{if(target<this.layers.length-1)
{var temp=this.layers[target+1];this.layers[target+1]=this.layers[target];this.layers[target]=temp;if(this.target==target)this.setTarget(this.target+1);else if(this.target==target+1)this.setTarget(this.target-1);}},orderDown:function(target)
{if(target>0)
{var temp=this.layers[target-1];this.layers[target-1]=this.layers[target];this.layers[target]=temp;if(this.target==target)this.setTarget(this.target-1);else if(this.target==target-1)this.setTarget(this.target+1);}},reset:function()
{this.layers.length=0;this.addLayer();},Layer:function(layerName)
{this.name=layerName;this.link=-1;this.display=1;this.tree=1;this.elements=[];}};Layers.prototype.Layer.prototype={nameChange:function(layerName){this.name=layerName;},addLine:function(xy1,xy2,color,weight,alpha,foreground)
{xy1[0]=Math.round(xy1[0]);xy1[1]=Math.round(xy1[1]);xy2[0]=Math.round(xy2[0]);xy2[1]=Math.round(xy2[1]);this.elements.push(new this.Line([xy1[0],xy1[1]],[xy2[0],xy2[1]],color,weight,alpha,foreground));},addCurve:function()
{},moveElement:function(target,xy1,xy2)
{this.elements[target].x1+=xy1[0];this.elements[target].y1+=xy1[1];this.elements[target].x2+=xy2[0];this.elements[target].y2+=xy2[1];},updateLine:function(target)
{var this_=this;return{x1:function(value){value=Math.round(value);this_.elements[target].x1=value;},y1:function(value){value=Math.round(value);this_.elements[target].y1=value;},x2:function(value){value=Math.round(value);this_.elements[target].x2=value;},y2:function(value){value=Math.round(value);this_.elements[target].y2=value;},xy1:function(xy){xy[0]=Math.round(xy[0]);xy[1]=Math.round(xy[1]);this_.elements[target].x1=xy[0];this_.elements[target].y1=xy[1];},xy2:function(xy){xy[0]=Math.round(xy[0]);xy[1]=Math.round(xy[1]);this_.elements[target].x2=xy[0];this_.elements[target].y2=xy[1];},color:function(color_){this_.elements[target].color=color_;},weight:function(weight_){this_.elements[target].weight=weight_;},alpha:function(alpha_){this_.elements[target].alpha=alpha_;},foreground:function(foreground_){this_.elements[target].foreground=foreground_;return foreground_;},display:function(display_){if(display_==undefined)this_.elements[target].display^=1;else this_.elements[target].display=display_;}};},updateCurve:function()
{},delElement:function(target){this.elements.splice(target,1);},orderUp:function(target)
{if(target<this.elements.length-1){var temp=this.elements[target+1];this.elements[target+1]=this.elements[target];this.elements[target]=temp;return target+1;}
return target;},orderDown:function(target)
{if(target>0){var temp=this.elements[target-1];this.elements[target-1]=this.elements[target];this.elements[target]=temp;return target-1;}
return target;},setLink:function(target)
{var tar=parseInt(target);this.link=target;},toggleDisplay:function(){this.display^=1;},toggleTree:function(){this.tree^=1;},Line:function(xy1,xy2,color,weight,alpha,foreground)
{this.x1=xy1[0];this.y1=xy1[1];this.x2=xy2[0];this.y2=xy2[1];this.color=color;this.weight=weight;this.alpha=alpha;this.foreground=foreground;this.display=1;},Curve:function(xy1,xy2,c,color,weight,alpha,foreground)
{this.x1=xy1[0];this.y1=xy1[1];this.x2=xy2[0];this.y2=xy2[1];this.cx=c[0];this.cy=c[1];this.color=color;this.weight=weight;this.alpha=alpha;this.foreground=foreground;this.display=1;}};var Draw=function(p){var winX=window.innerWidth;var winY=window.innerHeight;var cardinal=[Math.round(winX/2-400),Math.round(winY/2-300)];var center=[0,0];var mode="new";var mouse=[0,0];var newline=[0,0,0,0];var newlines=[];var oldline=[0,0,0,0];var target=-1;var pretarget=-1;var wait=0;var sorted=0;var zoom=1;var ctx=canvas.getContext('2d');var img=new Image();p.imgAlpha=0.5;p.imgX=0;p.imgY=0;var backgroundColor="#6a7495";var weight=2;var color="ffffff";var alpha=1;var foreground=0;var helper={start:1,end:1,middle:1,target:1};var layer=new Layers();var layers=layer.layers;var els=layers[0].elements;var setCardinal=function(x,y){cardinal[0]=x;cardinal[1]=y;}
var setCenter=function(x,y){center[0]=x;center[1]=y;}
var getMouseX=function(){return p.mouseX;}
var getMouseY=function(){return p.mouseY;}
var getCardinalX=function(){return cardinal[0];}
var getCardinalY=function(){return cardinal[1];}
var getCenterX=function(){return center[0];}
var getCenterY=function(){return center[1];}
p.setup=function()
{p.frameRate(60);p.rectMode(p.CENTER);p.size(winX,winY);};p.draw=function()
{if(wait==1)return;if(wait==0)wait++;else wait=1;p.format();p.elements(0);p.elements(1);p.layerDisplay();if(mode=="new")
{if(newline[0]!=newline[3]&&newline[2]!=newline[4])
p.LINE([newline[0],newline[1]],[newline[2],newline[3]],color,weight,alpha*100);}
if(mode=="moving1"||mode=="moving2"||mode=="moving3")
{p.LINE([newline[0],newline[1]],[newline[2],newline[3]],els[pretarget].color,els[pretarget].weight,els[target].alpha*100);}
$("#information").html("Information:<br />");$("#information").append("mouseX = "+(p.mouseX-cardinal[0]-center[0])+", mouseY = "+(p.mouseY-cardinal[1]-center[1]));$("#information").append(", centerX = "+center[0]+", centerY = "+center[1]);$("#information").append("<br />Mode = "+mode);$("#information").append("<br />Target = "+(target+1)+" in \""+layers[layer.target].name+"\"");$("#information").append("<br />Zoom = "+zoom);var elNumber=0;for(var i=0;i<layers.length;i++)
for(var j=0;j<layers[i].elements.length;j++)
elNumber++;$("#layerInfo").html("Layer: "+layers.length+", Element: "+elNumber);};p.mousePressed=function()
{if(p.mouseButton!=p.LEFT)return;wait=-1;mouse=[p.mouseX-cardinal[0]-center[0],p.mouseY-cardinal[1]-center[1]];if(mode=="new")p.setNewline(mouse[0],mouse[1],mouse[0],mouse[1]);if(mode=="move1"||mode=="move2"||mode=="move3")p.setTarget(pretarget);};p.mouseReleased=function()
{if(p.mouseButton!=p.LEFT)return;if(p.mouseButton!=p.LEFT)return;wait=-1;if(mode=="new")
{if(newline[0]!=newline[3]&&newline[2]!=newline[4])
{layers[layer.target].addLine([newline[0],newline[1]],[newline[2],newline[3]],color,weight,alpha,foreground);p.updateEls();p.setTarget(els.length-1);}
p.setNewline(0,0,0,0);}
if(mode=="moving1"||mode=="moving3")
{p.cursor(p.ARROW);mode="new";p.updateLine(pretarget).xy1([newline[2],newline[3]]);p.updateLine(pretarget).xy2([newline[0],newline[1]]);p.updateLine(pretarget).display(1);p.setNewline(0,0,0,0);}
if(mode=="moving2")
{mode="new";p.updateLine(pretarget).xy1([newline[2],newline[3]]);p.updateLine(pretarget).xy2([newline[0],newline[1]]);p.updateLine(pretarget).display(1);p.setNewline(0,0,0,0);}};p.mouseDragged=function()
{if(p.mouseButton!=p.LEFT)return;wait=-1;if(mode=="drag")center=[center[0]+(p.mouseX-cardinal[0]-center[0])-mouse[0],center[1]+(p.mouseY-cardinal[1]-center[1])-mouse[1]];if(mode=="new")p.setNewline(mouse[0],mouse[1],p.mouseX-cardinal[0]-center[0],p.mouseY-cardinal[1]-center[1]);if(mode=="move1")
{mode="moving1";mouse=[els[pretarget].x2,els[pretarget].y2];p.setNewline(mouse[0],mouse[1],mouse[0],mouse[1]);p.setTarget(pretarget);p.updateLine(pretarget).display(0);}
if(mode=="move3")
{mode="moving3";mouse=[els[pretarget].x1,els[pretarget].y1];p.setNewline(mouse[0],mouse[1],mouse[0],mouse[1]);p.setTarget(pretarget);p.updateLine(pretarget).display(0);}
if(mode=="move2")
{mode="moving2";mouse=[(els[pretarget].x1+els[pretarget].x2)/2,(els[pretarget].y1+els[pretarget].y2)/2];oldline=[els[pretarget].x2,els[pretarget].y2,els[pretarget].x1,els[pretarget].y1];p.setTarget(pretarget);p.updateLine(pretarget).display(0);}
if(mode=="moving1")
{p.setNewline(mouse[0],mouse[1],p.mouseX-cardinal[0]-center[0],p.mouseY-cardinal[1]-center[1]);p.changeSelected().moveP1([newline[2],newline[3]]);}
if(mode=="moving2")
{var moved=[(p.mouseX-cardinal[0]-center[0])-mouse[0],(p.mouseY-cardinal[1]-center[1])-mouse[1]];p.setNewline(oldline[0]+moved[0],oldline[1]+moved[1],oldline[2]+moved[0],oldline[3]+moved[1]);p.changeSelected().moveP1([newline[2],newline[3]]);p.changeSelected().moveP2([newline[0],newline[1]]);}
if(mode=="moving3")
{p.setNewline(p.mouseX-cardinal[0]-center[0],p.mouseY-cardinal[1]-center[1],mouse[0],mouse[1]);p.changeSelected().moveP2([newline[0],newline[1]]);}};p.mouseMoved=function()
{var el;if(mode!="drag"&&mode!="layermove")
{els.reverse();for(var i in els)
{el=els[i];var mouse2=[p.mouseX-cardinal[0]-center[0],p.mouseY-cardinal[1]-center[1]];if(helper.middle&&distance(mouse2,[(el.x1+el.x2)/2,(el.y1+el.y2)/2])<7)
{p.cursor(p.MOVE);if(mode!="move2")p.wait();mode="move2";pretarget=els.length-i-1;break;}
else if(helper.start&&distance(mouse2,[el.x1,el.y1])<7)
{p.cursor(p.HAND);if(mode!="move1")p.wait();mode="move1";pretarget=els.length-i-1;break;}
else if(helper.end&&distance(mouse2,[el.x2,el.y2])<7)
{p.cursor(p.HAND);if(mode!="move3")p.wait();mode="move3";pretarget=els.length-i-1;break;}
else
{p.cursor(p.ARROW);if(mode!="new")p.wait();mode="new";}}
els.reverse();}};p.keyPressed=function()
{if(p.keyCode==27||p.keyCode==82)center=[0,0];if(p.keyCode==32)mode="drag";if(p.keyCode==76)mode="layermove";var el=els[target];if(p.keyCode==37&&target!=-1)p.moveElement(target,[-1,0],[-1,0]);if(p.keyCode==38&&target!=-1)p.moveElement(target,[0,-1],[0,-1]);if(p.keyCode==39&&target!=-1)p.moveElement(target,[1,0],[1,0]);if(p.keyCode==40&&target!=-1)p.moveElement(target,[0,1],[0,1]);if(p.keyCode==83)setHelper("start");if(p.keyCode==77)setHelper("middle");if(p.keyCode==69)setHelper("end");if(p.keyCode==84)setHelper("target");p.wait();};p.keyReleased=function()
{wait=-1;if(p.keyCode==32)mode="new";if(p.keyCode==76)mode="new";if(p.keyCode==127||p.keyCode==68)
{layers[layer.target].delElement(target);setTarget(target-1);}};p.resize=function()
{wait=-1;winX=window.innerWidth;winY=window.innerHeight;cardinal=[Math.round(winX/2-400),Math.round(winY/2-300)];p.size(winX,winY);p.redraw();};p.wait=function()
{wait=-1;};p.setHelper=function(which)
{helper[which]^=1;p.wait();return helper[which];};p.setLayerTarget=function(value)
{layer.setTarget(value);p.updateEls();p.wait();};p.setTarget=function(value)
{target=value;if(target<0)target=0;p.setSelected(target);p.updateSelectedSlider();p.wait();$("#canvas")[0].focus();};p.setPretarget=function(value)
{pretarget=value;p.wait();};p.setNewline=function(value1,value2,value3,value4)
{value1=Math.round(value1);value2=Math.round(value2);value3=Math.round(value3);value4=Math.round(value4);newline=[value1,value2,value3,value4];p.wait();};p.setSelected=function(tar)
{if(els[target]==undefined)
{$("#selectedZ span").text("-");$("#selectedX1").val("");$("#selectedY1").val("");$("#selectedX2").val("");$("#selectedY2").val("");$("#selectedColor").val("");$("#selectedWeight").val("");$("#selectedAlpha").val("");$("#selectedForeground").removeClass("off").removeClass("on");$("#selectedForeground").addClass("disable");}else{var el=els[target];$("#selectedZ span").text(target);$("#selectedX1").val(el.x1);$("#selectedY1").val(el.y1);$("#selectedX2").val(el.x2);$("#selectedY2").val(el.y2);$("#selectedColor").val(el.color);$("#selectedWeight").val(el.weight);$("#selectedAlpha").val(parseInt(el.alpha*100));$("#selectedForeground").removeClass("off").removeClass("on").removeClass("disable");$("#selectedForeground").addClass((el.foreground)?"on":"off");}}
p.updateSelectedSlider=function()
{updateSelectedSliderDo();}
p.changeSelected=function(ifselected)
{return{moveP1:function(value){$(selectedX1).val(value[0]);$(selectedY1).val(value[1]);},moveP2:function(value){$(selectedX2).val(value[0]);$(selectedY2).val(value[1]);},x1:function(value){value=parseInt(value);if(!isNaN(value))p.updateLine(target,ifselected).x1(value);p.wait();},y1:function(value){value=parseInt(value);if(!isNaN(value))p.updateLine(target,ifselected).y1(value);p.wait();},x2:function(value){value=parseInt(value);if(!isNaN(value))p.updateLine(target,ifselected).x2(value);p.wait();},y2:function(value){value=parseInt(value);if(!isNaN(value))p.updateLine(target,ifselected).y2(value);p.wait();},color:function(value){var clr=getRGB(value);if(clr==null)return;p.updateLine(target).color(value);$("#selectedColor").val(value);p.wait();},weight:function(value){p.updateLine(target).weight(value);$("#selectedWeight").val(value);p.wait();},alpha:function(value){p.updateLine(target).alpha(value/100);$("#selectedAlpha").val(value);p.wait();},foreground:function(){return p.updateLine(target).foreground((els[target].foreground)?0:1);}};}
p.setColor=function(value){var clr=getRGB(value);if(clr==null)return;color=value;};p.setWeight=function(value){weight=value;};p.setAlpha=function(value){alpha=value/100;};p.setForeground=function(value){foreground^=1;return foreground;};p.getZoom=function(){return zoom;};p.getColor=function(){return color;};p.getWeight=function(){return weight;};p.getAlpha=function(){return alpha*100;};p.getForeground=function(){return foreground;};p.toggleTree=function(tar){layers[tar].toggleTree();p.wait();};p.toggleDisplay=function(tar){layers[tar].toggleDisplay();p.wait();};p.getLayer=function(){return layer;};p.getLayers=function(){return layers;};p.BACKGROUND=function(c)
{var clr=getRGB(c);if(clr==null)return;p.background(clr.r,clr.g,clr.b);};p.RECT=function(xy,w,h,s,c,a)
{var clr=getRGB(c);if(clr==null)return;p.stroke(clr.r,clr.g,clr.b);p.fill(clr.r,clr.g,clr.b);p.rect(cardinal[0]+xy[0]+center[0],cardinal[1]+xy[1]+center[1],w,h);};p.LINE=function(xy1,xy2,c,w,a)
{var clr=getRGB(c);if(clr==null)return;p.stroke(p.color(clr.r,clr.g,clr.b,a));p.strokeWeight(w);p.line(cardinal[0]+xy1[0]+center[0],cardinal[1]+xy1[1]+center[1],cardinal[0]+xy2[0]+center[0],cardinal[1]+xy2[1]+center[1])};p.DOT=function(xy,c,w,a)
{var clr=getRGB(c);if(clr==null)return;p.stroke(p.color(clr.r,clr.g,clr.b,a));p.strokeWeight(w);p.line(cardinal[0]+xy[0]+center[0],cardinal[1]+xy[1]+center[1],cardinal[0]+xy[0]+center[0],cardinal[1]+xy[1]+center[1])};p.IMAGE=function(url)
{img.src=url;ctx.save();ctx.globalAlpha=p.imgAlpha;ctx.drawImage(img,p.imgX+cardinal[0],p.imgY+cardinal[1]);ctx.restore();}
p.format=function()
{p.BACKGROUND(backgroundColor);var clr=getRGB(backgroundColor);if(clr==null)return;var formatColor=(parseInt(clr.r)+parseInt(clr.g)+parseInt(clr.b))/3>127?"#000000":"#ffffff";p.LINE([0,0],[800,0],formatColor,1,64);p.LINE([0,22],[800,22],formatColor,1,64);p.LINE([0,400],[800,400],formatColor,1,64);p.LINE([0,600],[800,600],formatColor,1,64);p.LINE([0,0],[0,600],formatColor,1,64);p.LINE([800,0],[800,600],formatColor,1,64);};p.elements=function(_foreground)
{for(var i=0;i<layers.length;i++)
{if(!layers[i].display)continue;for(var j=0;j<layers[i].elements.length;j++)
{var el=layers[i].elements[j];if(!el.display)continue;if(_foreground!=el.foreground)continue;p.LINE([el.x1,el.y1],[el.x2,el.y2],el.color,el.weight,el.alpha*255);if(i==layer.target)
{if(helper.start)
{p.LINE([el.x1-5,el.y1],[el.x1+5,el.y1],"#6a7495",2,255);p.LINE([el.x1,el.y1-5],[el.x1,el.y1+5],"#6a7495",2,255);p.LINE([el.x1-5,el.y1],[el.x1+5,el.y1],"#ffff00",1,255);p.LINE([el.x1,el.y1-5],[el.x1,el.y1+5],"#ffff00",1,255);}
if(helper.middle)
{p.LINE([(el.x1+el.x2)/2-5,(el.y1+el.y2)/2],[(el.x1+el.x2)/2+5,(el.y1+el.y2)/2],"#6a7495",2,255);p.LINE([(el.x1+el.x2)/2,(el.y1+el.y2)/2-5],[(el.x1+el.x2)/2,(el.y1+el.y2)/2+5],"#6a7495",2,255);p.LINE([(el.x1+el.x2)/2-5,(el.y1+el.y2)/2],[(el.x1+el.x2)/2+5,(el.y1+el.y2)/2],"#00ffff",1,255);p.LINE([(el.x1+el.x2)/2,(el.y1+el.y2)/2-5],[(el.x1+el.x2)/2,(el.y1+el.y2)/2+5],"#00ffff",1,255);}
if(helper.end)
{p.LINE([el.x2-5,el.y2],[el.x2+5,el.y2],"#6a7495",2,255);p.LINE([el.x2,el.y2-5],[el.x2,el.y2+5],"#6a7495",2,255);p.LINE([el.x2-5,el.y2],[el.x2+5,el.y2],"#ffff00",1,255);p.LINE([el.x2,el.y2-5],[el.x2,el.y2+5],"#ffff00",1,255);}
if(helper.target&&j==target)
{p.DOT([(el.x1+el.x2)/2,(el.y1+el.y2)/2],"#ffffff",12,255);p.DOT([(el.x1+el.x2)/2,(el.y1+el.y2)/2],"#6a7495",10,255);p.DOT([(el.x1+el.x2)/2,(el.y1+el.y2)/2],"#ffffff",6,255);}}}}};p.updateEls=function(){els=layers[layer.target].elements;}
p.addLayer=function(){els=layers[layer.addLayer()].elements;p.setTarget(-1);p.wait();}
p.delLayer=function(tar){els=layers[layer.delLayer(tar)].elements;p.setTarget(-1);p.wait();}
p.updateLine=function(tar,ifselected){var res=layers[layer.target].updateLine(tar);if(ifselected==undefined)p.setSelected();return res;}
p.moveElement=function(tar,xy1,xy2){layers[layer.target].moveElement(tar,xy1,xy2);p.setSelected();}
p.elementOrderUp=function(){p.setTarget(layers[layer.target].orderUp(target));p.wait();}
p.elementOrderDown=function(){p.setTarget(layers[layer.target].orderDown(target));p.wait();}
p.layerOrderDown=function(tar){layer.orderDown(tar);p.setTarget(-1);p.wait();}
p.layerOrderUp=function(tar){layer.orderUp(tar);p.setTarget(-1);p.wait();}
p.layerSetLink=function(tar,linkGround){layers[tar].setLink(linkGround);p.wait();}
p.loadFirst=function(){p.delLayer(0);}
p.loadLayer=function(name,link){p.addLayer();layers[layer.target].nameChange(name);layers[layer.target].setLink(link);}
p.loadLine=function(xy1,xy2,color,weight,alpha,foreground){layers[layer.target].addLine([xy1[0],xy1[1]],[xy2[0],xy2[1]],color,weight,alpha,foreground);p.updateEls();p.setTarget(els.length-1);}
p.layerDisplay=function()
{var $e;$e=$("#layers");$e.empty();for(var i=layers.length-1;i>=0;i--)
{var $els=layers[i].elements;var res="<li><p id=\"layer"+i+"\"";if(layer.target==i)res+=" class=\"selected\"";res+=">";res+="<img src=\"./images/tree_";res+=layers[i].tree?"on":"off";res+=".gif\" onclick=\"toggleTree(this, "+i+")\" />";res+=" <input type=\"test\" id=\"layerName"+i+"\" value=\""+layers[i].name+"\" />";res+=" ["+$els.length+"]";if(layers[i].link!=-1)res+=" &lt;"+layers[i].link+"&gt;";res+="<span>"
if(i>0)res+="<img src=\"./images/order_down.gif\" onclick=\"layerOrderDown("+i+")\" /> ";if(i<layers.length-1)res+="<img src=\"./images/order_up.gif\" onclick=\"layerOrderUp("+i+")\" /> ";res+="<img src=\"./images/display_";res+=layers[i].display?"on":"off";res+=".gif\" onclick=\"toggleDisplay(this, "+i+")\" />";res+="</span>";res+="</p>";if(layers[i].tree)
{res+="<ul>";for(var j=$els.length-1;j>=0;j--)
{res+="<li onclick=\"setLayerTarget("+i+");setTarget("+j+")\"";if(layer.target==i&&target==j)res+="class=\"selected\"";res+="><span class=\"no\">"+(j+1)+"</span>P1=\""+$els[j].x1+","+$els[j].y1+"\" P2=\""+$els[j].x2+","+$els[j].y2+"\"<br />";res+="<span style=\"color: #"+$els[j].color+"\">c=\""+$els[j].color+","+$els[j].weight+","+$els[j].alpha+","+$els[j].foreground+"\"";if(layers[i].link!=-1)res+=" M1=\""+layers[i].link+"\" M2=\""+layers[i].link+"\"";res+="</span></li>";}
res+="</ul>";}
res+="</li>";$e.append(res);}
$("#layers p").click(function(e){if(e.target.tagName=="P")
{setLayerTarget(e.target.id.slice(5));}
if(e.target.tagName=="INPUT")
{layers[e.target.id.slice(9)].nameChange(e.target.value);setLayerTarget($(e.target).parent("p").attr("id").slice(5));}});$("#layers p").bind('contextmenu',function(e){$(document).bind('mousedown',function(){$(document).unbind('mousedown');});var linker="<select id=\"linkTarget\"><option value=\"-1\">None</option>";for(var j=1;j<50;j++)linker+="<option value=\""+j+"\">"+j+"</option>";linker+="</select>";var e;if(e.target.tagName!="P")e=$(e.target).parent("p");else e=$(e.target);e.append("<div>"+"<button onclick=\"$(this).parent('div').parent('p').children('input')[0].focus();$(this).parent('div').parent('p').children('input')[0].select();$(this).parent('div').remove('div');\">Rename</button>"+"<button onclick=\"if(confirm('Do you want to delete this layer?')){delLayer($(this).parent('div').parent('p')[0].id.slice(5));};$(this).parent('div').remove('div');\">Delete</button>"+
linker+"<button onclick=\"layerSetLink($(this).parent('div').parent('p')[0].id.slice(5), $(this).parent('div').children('select').val());$(this).parent('div').remove('div');\">Link</button>"+"</div>");return false;});$("#layers p input").change(function(e){layers[e.target.id.slice(9)].nameChange(e.target.value);});}
p.reset=function()
{layer.reset()};p.setZoom=function(mag)
{zoom=mag;p.wait();}
p.move=function(target)
{};}
var Preview=function(p){p.w=2;p.c="#ffffff";p.a=255;p.wait=0;p.setup=function()
{p.frameRate(10);p.size(180,180);};p.draw=function()
{if(p.wait==1)return;if(p.wait==0)p.wait++;else p.wait=1;p.BACKGROUND("#6a7495");p.DOT(p.w,p.c,p.a);};p.call=function(w,c,a)
{p.wait=-1;if(w!=null)p.w=w;if(c!=null)p.c=c;if(a!=null)p.a=a*2.55;};p.BACKGROUND=function(c)
{var clr=getRGB(c);if(clr==null)return;p.background(clr.r,clr.g,clr.b);};p.DOT=function(w,c,a)
{var clr=getRGB(c);if(clr==null)return;p.stroke(p.color(clr.r,clr.g,clr.b,a));p.strokeWeight(w);p.line(90,90,90,90)};}
window.onresize=function()
{processing.resize();};function setHelper(which)
{var res=processing.setHelper(which);$("#"+which).removeClass("off").removeClass("on");if(res)$("#"+which).addClass("on");else $("#"+which).addClass("off");}
function setZoom(value){processing.setZoom(value);}
function setTarget(value){processing.setTarget(value);}
function setLayerTarget(value){processing.setLayerTarget(value);}
function changeSelected(ifs){return processing.changeSelected(ifs);}
function selectedForeground(but){var res=processing.changeSelected().foreground();but.className=res?"on":"off";$(but).text(res?"FOREGROUND":"BACKGROUND");processing.wait();}
function color(value){processing.setColor(value);processing2.call(null,value,null);}
function weight(value){processing.setWeight(value);processing2.call(value,null,null);}
function alpha(value){processing.setAlpha(value);processing2.call(null,null,value);}
function foreground(but){var res=processing.setForeground();but.className=res?"on":"off";$(but).text(res?"FOREGROUND":"BACKGROUND");processing.wait();}
function addLayer(){processing.addLayer();}
function delLayer(target){processing.delLayer(target);}
function layerOrderDown(target){processing.layerOrderDown(target);}
function layerOrderUp(target){processing.layerOrderUp(target);}
function layerSetLink(target,linkGround){processing.layerSetLink(target,linkGround);}
function elementOrderDown(){processing.elementOrderDown();}
function elementOrderUp(){processing.elementOrderUp();}
function toggleTree(onoff,target){processing.toggleTree(target);$(onoff).toggleClass("off");}
function toggleDisplay(onoff,target){processing.toggleDisplay(target);$(onoff).toggleClass("off");}
function reset(){processing.reset();}
function generateXML()
{res="<C><P /><Z><S /><D /><O /><L>";var layer=processing.getLayer();var layers=processing.getLayers();for(var i=0;i<layers.length;i++)
{if(!layers[i].display)continue;res+="<VDEL n=\""+layers[i].name+"\"l=\""+layers[i].link+"\"/>";for(var j=0;j<layers[i].elements.length;j++)
{var el=layers[i].elements[j];if(!el.display)continue;var dot=0;if(el.x1==el.x2&&el.y1==el.y2)dot++;res+='<JD P1="'+el.x1+','+el.y1+'"P2="'+el.x2+','+(el.y2+dot)+'"c="'+el.color+','+el.weight+','+el.alpha+','+el.foreground+'"';if(layers[i].link!=-1)res+='M1="'+layers[i].link+'"M2="'+layers[i].link+'"';res+='/>';}}
res+="</L></Z></C>";$("#xmlText").val(res);}
function load()
{var layer=processing.getLayer();var layers=processing.getLayers();reset();var xml=$("#xmlLoad").val();var p1;var p2;var c;var link;var first=0;$(xml).find("JD, VDEL").each(function(index,e)
{if(e.tagName=="VDEL")
{if($(this).attr("n")!=null&&$(this).attr("l")!=null)
{link=parseInt($(this).attr("l"));if(isNaN(link))return;if(first==0)first=1;processing.loadLayer($(this).attr("n"),link);}}
if(e.tagName=="JD")
{if($(this).attr("P1")!=null&&$(this).attr("P2")!=null&&$(this).attr("c")!=null)
{if(first==0)first=-1;p1=$(this).attr("P1").split(",");p2=$(this).attr("P2").split(",");c=$(this).attr("c").split(",");if(p1.length!=2||p2.length!=2||c.length!=4)return;p1[0]=parseInt(p1[0]);p1[1]=parseInt(p1[1]);p2[0]=parseInt(p2[0]);p2[1]=parseInt(p2[1]);c[1]=parseInt(c[1]);c[2]=parseInt(c[2]*100)/100;c[3]=parseInt(c[3]);if(isNaN(p1[0]))return;if(isNaN(p1[1]))return;if(isNaN(p2[0]))return;if(isNaN(p2[1]))return;if(isNaN(c[1]))return;if(isNaN(c[2]))return;if(isNaN(c[3]))return;if(getRGB("#"+c[0])==null)return;processing.loadLine([p1[0],p1[1]],[p2[0],p2[1]],c[0],c[1],c[2],c[3]);}}});if(first==1)processing.loadFirst();processing.wait();}
function getRGB(hex){var res=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return res?{r:parseInt(res[1],16),g:parseInt(res[2],16),b:parseInt(res[3],16)}:null;}
function winPop(value)
{$("#log").css("display","none");$("#help").css("display","none");$("#load").css("display","none");$("#xml").css("display","none");$("#"+value).css("display","block");}
$(function(){canvas=$("#canvas")[0];processing=new Processing(canvas,Draw);var preview=$("#preview")[0];processing2=new Processing(preview,Preview);$("#selectedX1").val("");$("#selectedY1").val("");$("#selectedX2").val("");$("#selectedY2").val("");$("#selectedColor").val("");$("#selectedWeight").val("");$("#selectedAlpha").val("");$("#selectedX1").bind("keyup",function(){changeSelected(-1).x1(this.value);});$("#selectedY1").bind("keyup",function(){changeSelected(-1).y1(this.value);});$("#selectedX2").bind("keyup",function(){changeSelected(-1).x2(this.value);});$("#selectedY2").bind("keyup",function(){changeSelected(-1).y2(this.value);});$("#zoom").val(processing.getZoom());$("#color").val(processing.getColor());$("#weight").val(processing.getWeight());$("#alpha").val(processing.getAlpha());$("#color").change(function(e){color($(this).val());});$("#weight").change(function(e){weight($(this).val());});$("#alpha").change(function(e){alpha($(this).val());});$(".draggable").draggable({handle:"h1",snap:true,scroll:false,start:function(e,ui)
{$(this).css("height",$(this).innerHeight());}});});